<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>حكيم — الجلدية | تقييمات ذكية + PDF</title>
  <meta name="description" content="حكيم — الجلدية: حب الشباب، إكزيما، صدفية، شرى/وذمة وعائية، التهاب نسيج خلوي/حمرة، قوباء، فطور جلدية، فطور فروة (أطفال)، جرب، هربس نطاقي، هربس بسيط، وردية، آفة مصطبغة مشتبهة (ABCDE)، خراج/دمّل.">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --bg:#07090f; --txt:#e8ecff; --muted:#aab2d8;
      --primary:#7aa2ff; --primary-2:#00e0ff; --accent:#a855f7;
      --glass:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:'Cairo',system-ui,'Noto Sans Arabic',sans-serif; background:#07090f; color:var(--txt); line-height:1.9}
    header{position:sticky; top:0; z-index:50; display:flex; align-items:center; justify-content:space-between; padding:14px 20px; backdrop-filter:saturate(140%) blur(8px); background:linear-gradient(180deg, rgba(15,16,40,.85), rgba(15,16,40,.45)); border-bottom:1px solid var(--border)}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:42px; height:42px; border-radius:12px; display:grid; place-items:center; font-weight:800; background: radial-gradient(120% 120% at 0% 0%, var(--primary), var(--accent)); box-shadow: 0 0 24px rgba(122,162,255,.35), inset 0 0 18px rgba(255,255,255,.15)}
    .brand-text strong{display:block; font-size:18px}
    .brand-text span{display:block; font-size:12px; color:var(--muted)}
    .container{width:min(1180px,94vw); margin-inline:auto}
    h1{font-size:clamp(22px,4vw,34px); margin:22px 0 6px}
    .sub{color:#cfd6ff; margin:0 0 12px}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid var(--border); border-radius:22px; padding:22px; box-shadow:0 30px 60px rgba(0,10,40,.35)}
    .grid{display:grid; gap:16px}
    .grid-2{grid-template-columns:1fr}
    @media(min-width:1000px){.grid-2{grid-template-columns:1fr 1fr}}
    .choose{display:grid; gap:12px; grid-template-columns:repeat(2,1fr)}
    @media(min-width:920px){.choose{grid-template-columns:repeat(4,1fr)}}
    .opt{background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:16px; padding:14px; text-align:center; cursor:pointer; transition:transform .18s ease, border-color .18s ease; min-height:100px; display:grid; place-items:center; font-weight:700}
    .opt:hover{transform:translateY(-3px); border-color:rgba(122,162,255,.6)}
    .card{border:1px solid var(--border); border-radius:18px; background:rgba(255,255,255,0.04); padding:18px}
    label{font-weight:600}
    select, input[type="number"], input[type="text"]{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,0.03); color:var(--txt)}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:680px){.row{grid-template-columns:repeat(2,1fr)}}
    .row-3{display:grid; gap:12px; grid-template-columns:repeat(3,1fr)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--glass); color:var(--txt); cursor:pointer; font-weight:700; transition:transform .2s ease, background .2s ease}
    .btn.primary{background:linear-gradient(135deg, var(--primary), var(--primary-2)); border-color:transparent}
    .btn:hover{transform:translateY(-2px)}
    .result{padding:14px; border:1px solid var(--border); border-radius:14px; background:rgba(255,255,255,.03)}
    .hint{font-size:13px; color:#b8c0ef}
    footer{text-align:center; padding:22px; color:#aab2d8; font-size:13px; border-top:1px solid var(--border); margin-top:24px}
    .mt{margin-top:10px}.hide{display:none}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">حكيم</div>
    <div class="brand-text">
      <strong>حكيم — الجلدية</strong>
      <span>تقييمات مؤتمتة دقيقة + PDF</span>
    </div>
  </div>
  <nav class="actions" style="margin:0">
    <a class="btn" href="index.html">الصفحة الرئيسية</a>
  </nav>
</header>

<main class="container">
  <section class="glass">
    <h1>الجلدية — اختر القسم</h1>
    <p class="sub">أدخل بياناتك ثم اختر الحالة. ستظهر <b>خطة إرشادية + أمثلة أدوية (بدون جرعات)</b> للمراجعة مع الطبيب.</p>

    <div class="row">
      <div><label>الاسم:</label><input id="pat-name" type="text" placeholder="مثال: يمان فتال"></div>
      <div><label>العمر (سنوات):</label><input id="pat-age" type="number" min="0" max="120" placeholder="30"></div>
    </div>
    <div class="row">
      <div>
        <label>الجنس:</label>
        <select id="pat-sex">
          <option value="male">ذكر</option>
          <option value="female">أنثى</option>
          <option value="pregnant">حامل/محتمل الحمل</option>
        </select>
      </div>
    </div>

    <div class="choose" id="chooser">
      <div class="opt" data-target="acne">حبّ الشباب</div>
      <div class="opt" data-target="eczema">إكزيما/التهاب جلد أتوبـي</div>
      <div class="opt" data-target="psoriasis">صدفية</div>
      <div class="opt" data-target="urticaria">شرى/وذمة وعائية</div>
      <div class="opt" data-target="cellulitis">التهاب نسيج خلوي/حمرة</div>
      <div class="opt" data-target="impetigo">قوباء</div>
      <div class="opt" data-target="tinea">فطور جلدية (جسم/قدم/أُرْبِيّة)</div>
      <div class="opt" data-target="tinea-capitis">فطور فروة (أطفال)</div>
      <div class="opt" data-target="scabies">جرب</div>
      <div class="opt" data-target="zoster">هربس نطاقي</div>
      <div class="opt" data-target="hsv">هربس بسيط</div>
      <div class="opt" data-target="rosacea">وردية</div>
      <div class="opt" data-target="melanoma">آفة مُصطبغة مشتبهة (ABCDE)</div>
      <div class="opt" data-target="abscess">خراج/دمّل</div>
    </div>
    <p class="hint mt">أعلام طارئة: تورّم شفتين/لسان مع ضيق نفس (تأق)، ألم شديد يتجاوز المظهر/حُمّى مرتفعة مع احمرار ممتد سريعًا (نخر ليفي)، طفح حول العين مع ألم شديد/تشوّش رؤية (هربس عيني)، حمّى مع قشور شائعة عند رضيع/مسن — اطلب الإسعاف فورًا.</p>
  </section>

  <section class="grid grid-2 mt">
    <!-- 1) Acne -->
    <div class="card hide" id="sec-acne">
      <h2>حبّ الشباب — فرز شدة</h2>
      <div class="row-3">
        <div><label>زؤانات سوداء/بيضاء</label><select id="acComed"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>حطاطات/بثور ملتهبة</label><select id="acInflam"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>عُقَد/أكياس/ندبات</label><select id="acNodCys"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcAcne()">تقييم حبّ الشباب</button>
        <button class="btn" onclick="exportPDF('acne')">تصدير PDF</button>
      </div>
      <div class="result mt" id="acne-res"></div>
    </div>

    <!-- 2) Eczema -->
    <div class="card hide" id="sec-eczema">
      <h2>إكزيما/التهاب جلد أتوبـي — فرز</h2>
      <div class="row">
        <div><label>حكّة مزمنة مع جفاف</label><select id="ecItchDry"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>بقع حمامية متقشرة/حويصلية</label><select id="ecErupt"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="row">
        <div><label>تفاقم مع صابون/عطور/صوف</label><select id="ecTriggers"><option value="0">لا/غير واضح</option><option value="1">نعم</option></select></div>
        <div><label>علامات إنتان (قشور عسليّة/قيح/حمّى)</label><select id="ecInfect"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcEczema()">تقييم الإكزيما</button>
        <button class="btn" onclick="exportPDF('eczema')">تصدير PDF</button>
      </div>
      <div class="result mt" id="eczema-res"></div>
    </div>

    <!-- 3) Psoriasis -->
    <div class="card hide" id="sec-psoriasis">
      <h2>صدفية — فرز</h2>
      <div class="row">
        <div><label>لويحات سميكة بحدود واضحة مع قشور فضية</label><select id="psPlaque"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>أظافر منقرة/سماكة/انفصال</label><select id="psNail"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="row">
        <div><label>ألم/تورّم مفاصل (صدفية مفصلية)</label><select id="psArth"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>مساحة واسعة &gt;10% تقريبًا</label><select id="psWide"><option value="0">لا/غير معروف</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcPsoriasis()">تقييم الصدفية</button>
        <button class="btn" onclick="exportPDF('psoriasis')">تصدير PDF</button>
      </div>
      <div class="result mt" id="psoriasis-res"></div>
    </div>

    <!-- 4) Urticaria/Angioedema -->
    <div class="card hide" id="sec-urticaria">
      <h2>شرى/وذمة وعائية — إنذار فرط التحسس</h2>
      <div class="row">
        <div><label>شرى مهاجر حاكّ</label><select id="urHives"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>وذمة شفتين/لسان/حول العين</label><select id="urAngio"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="row">
        <div><label>صفير/ضيق نفس/هبوط ضغط</label><select id="urAnaph"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>دواء/طعام جديد</label><select id="urTrigger"><option value="0">لا/غير معروف</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcUrticaria()">تقييم الشرى/الوذمة</button>
        <button class="btn" onclick="exportPDF('urticaria')">تصدير PDF</button>
      </div>
      <div class="result mt" id="urticaria-res"></div>
    </div>

    <!-- 5) Cellulitis/Erysipelas -->
    <div class="card hide" id="sec-cellulitis">
      <h2>التهاب نسيج خلوي/حمرة — فرز شدة</h2>
      <div class="row">
        <div><label>احمرار/سخونة/ألم موضعي</label><select id="ceBasic"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>خطوط لمفية/تورّم شديد</label><select id="ceLymph"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="row">
        <div><label>حمّى/قشعريرة</label><select id="ceFever"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>ألم أشد من المظهر/نُفاخ/فقاعات</label><select id="ceNecro"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcCellulitis()">تقييم الالتهاب</button>
        <button class="btn" onclick="exportPDF('cellulitis')">تصدير PDF</button>
      </div>
      <div class="result mt" id="cellulitis-res"></div>
    </div>

    <!-- 6) Impetigo -->
    <div class="card hide" id="sec-impetigo">
      <h2>قوباء — فرز</h2>
      <div class="row">
        <div><label>قشور عسلية على الوجه/حول الأنف والفم</label><select id="imHoney"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>آفات متعددة/انتشار سريع</label><select id="imSpread"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcImpetigo()">تقييم القوباء</button>
        <button class="btn" onclick="exportPDF('impetigo')">تصدير PDF</button>
      </div>
      <div class="result mt" id="impetigo-res"></div>
    </div>

    <!-- 7) Tinea -->
    <div class="card hide" id="sec-tinea">
      <h2>فطور جلدية (جسم/قدم/أُرْبِيّة) — فرز</h2>
      <div class="row">
        <div><label>بقع حلقية محددة مع قشور/حافة فاعلة</label><select id="tiRing"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>حكّة/تشقق بين الأصابع</label><select id="tiItch"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcTinea()">تقييم الفطور</button>
        <button class="btn" onclick="exportPDF('tinea')">تصدير PDF</button>
      </div>
      <div class="result mt" id="tinea-res"></div>
    </div>

    <!-- 8) Tinea capitis -->
    <div class="card hide" id="sec-tinea-capitis">
      <h2>فطور فروة (أطفال) — فرز</h2>
      <div class="row">
        <div><label>قشور مع تقطّع الشعر/بقع صلعاء</label><select id="tcScale"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>عقدة/التهاب شديد (كرِيون)</label><select id="tcKerion"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcTineaCapitis()">تقييم فطور الفروة</button>
        <button class="btn" onclick="exportPDF('tinea-capitis')">تصدير PDF</button>
      </div>
      <div class="result mt" id="tinea-capitis-res"></div>
    </div>

    <!-- 9) Scabies -->
    <div class="card hide" id="sec-scabies">
      <h2>جرب — فرز</h2>
      <div class="row">
        <div><label>حكّة ليلية شديدة</label><select id="scNight"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>مسارات رفيعة بين الأصابع/المعصم/السرة</label><select id="scBurrow"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="row">
        <div><label>إصابة منزلية/مدرسية مماثلة</label><select id="scHouse"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>قشور مفرطة/مناعة ضعيفة (قِرَفي)</label><select id="scCrust"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcScabies()">تقييم الجرب</button>
        <button class="btn" onclick="exportPDF('scabies')">تصدير PDF</button>
      </div>
      <div class="result mt" id="scabies-res"></div>
    </div>

    <!-- 10) Zoster -->
    <div class="card hide" id="sec-zoster">
      <h2>هربس نطاقي (زنّار) — فرز</h2>
      <div class="row">
        <div><label>ألم/حرق يسبقه طفح حويصلي في مسار جلدي أحادي الجانب</label><select id="zoDerm"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>إصابة حول/داخل العين (V1)</label><select id="zoEye"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="row">
        <div><label>زمن البدء ≤ 72 ساعة</label><select id="zoEarly"><option value="0">لا/أكثر</option><option value="1">نعم</option></select></div>
        <div><label>عمر ≥ 50 أو مناعة ضعيفة</label><select id="zoRisk"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcZoster()">تقييم الهربس النطاقي</button>
        <button class="btn" onclick="exportPDF('zoster')">تصدير PDF</button>
      </div>
      <div class="result mt" id="zoster-res"></div>
    </div>

    <!-- 11) HSV -->
    <div class="card hide" id="sec-hsv">
      <h2>هربس بسيط — شفة/تناسلي</h2>
      <div class="row">
        <div><label>حويصلات مؤلمة متجمّعة</label><select id="hsVes"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>نكسات مرتبطة بالشمس/الجهد/الطمث</label><select id="hsRec"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="row">
        <div><label>موضع تناسلي/ألم تبول</label><select id="hsGen"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>حمل/مناعة ضعيفة</label><select id="hsRisk"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcHSV()">تقييم الهربس البسيط</button>
        <button class="btn" onclick="exportPDF('hsv')">تصدير PDF</button>
      </div>
      <div class="result mt" id="hsv-res"></div>
    </div>

    <!-- 12) Rosacea -->
    <div class="card hide" id="sec-rosacea">
      <h2>وردية — فرز</h2>
      <div class="row">
        <div><label>احمرار مركزي بالوجه/اندفاعات/أوعية دقيقة</label><select id="roFace"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>حفّاز: حرارة/بهارات/كحول/انفعال</label><select id="roTrigger"><option value="0">لا/غير معروف</option><option value="1">نعم</option></select></div>
      </div>
      <div class="row">
        <div><label>تورّم أنف/سماكة جلد (رِينُفِيمَا)</label><select id="roRhin"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>أعراض عينية (جفاف/حرق/احمرار)</label><select id="roEye"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcRosacea()">تقييم الوردية</button>
        <button class="btn" onclick="exportPDF('rosacea')">تصدير PDF</button>
      </div>
      <div class="result mt" id="rosacea-res"></div>
    </div>

    <!-- 13) Melanoma suspect -->
    <div class="card hide" id="sec-melanoma">
      <h2>آفة مُصطبغة مشتبهة — ABCDE</h2>
      <div class="row">
        <div><label>عدم تناظر/حدود غير منتظمة</label><select id="meAsyBor"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>ألوان متعددة ضمن الآفة</label><select id="meColor"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="row">
        <div><label>قطر &gt; 6 مم</label><select id="meSize"><option value="0">لا/غير معروف</option><option value="1">نعم</option></select></div>
        <div><label>تطوّر سريع/نزف/حكّة</label><select id="meEvol"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcMelanoma()">تقييم الاشتباه</button>
        <button class="btn" onclick="exportPDF('melanoma')">تصدير PDF</button>
      </div>
      <div class="result mt" id="melanoma-res"></div>
    </div>

    <!-- 14) Abscess -->
    <div class="card hide" id="sec-abscess">
      <h2>خراج/دمّل — فرز</h2>
      <div class="row">
        <div><label>كتلة مؤلمة حارة مع تقلب/رأس قيحي</label><select id="abFluct"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>حمّى/احمرار واسع</label><select id="abFever"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="row">
        <div><label>موضع عالي الخطورة (وجه/حول الشفة/منطقة مثلث خطير)</label><select id="abDanger"><option value="0">لا</option><option value="1">نعم</option></select></div>
        <div><label>سكري/مناعة ضعيفة/MRSA محتمل</label><select id="abRisk"><option value="0">لا</option><option value="1">نعم</option></select></div>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="calcAbscess()">تقييم الخراج</button>
        <button class="btn" onclick="exportPDF('abscess')">تصدير PDF</button>
      </div>
      <div class="result mt" id="abscess-res"></div>
    </div>
  </section>

  <section class="glass mt">
    <p class="hint">هذه الصفحة للتثقيف والفرز الأولي. عند الشك بحالة إسعافية — تواصل مع الإسعاف فورًا.</p>
  </section>
</main>

<footer>© <span id="year"></span> حكيم — جميع الحقوق محفوظة.</footer>

<script>
  // ====== عام ======
  document.getElementById('year').textContent = new Date().getFullYear();
  document.querySelectorAll('#chooser .opt').forEach(el=>{
    el.addEventListener('click', ()=>{
      document.querySelectorAll('.card').forEach(c=>c.classList.add('hide'));
      const sec = document.getElementById('sec-'+el.getAttribute('data-target'));
      if (sec){ sec.classList.remove('hide'); sec.scrollIntoView({behavior:'smooth', block:'start'}); }
    });
  });

  // المستخدم
  function nameVal(){ return document.getElementById('pat-name').value?.trim() || 'بدون اسم'; }
  function ageVal(){ const n=parseInt(document.getElementById('pat-age').value,10); return isNaN(n)? null : Math.min(120, Math.max(0,n)); }
  function sexVal(){
    const v=document.getElementById('pat-sex').value;
    return {code:v, label:(v==='male'?'ذكر': (v==='female'?'أنثى':'حامل/محتمل الحمل'))};
  }
  function userContext(){
    const age=ageVal(), sex=sexVal();
    return {
      name:nameVal(), age, sex,
      child: age!=null && age<14,
      older: age!=null && age>=65,
      pregnant: sex.code==='pregnant',
      male: sex.code==='male', female: sex.code!=='male'
    };
  }
  function yes(id){ return document.getElementById(id).value==='1'; }
  function lines(arr){ return `<ul>${arr.map(x=>`<li>${x}</li>`).join('')}</ul>`; }
  function setLast(obj){ window._last = obj; }

  // ====== صانع الخطط للجلدية ======
  function buildPlanDerm(domain, ctx, u){
    const plan=[], rec=[], pharm=[], flags = ctx.flags? [...ctx.flags] : [];
    if (u.child) rec.push('الفئة طفل: الجرعات/الاختيارات تختلف — يلزم اختصاص أطفال.');
    if (u.older) rec.push('العمر ≥65: انتبه لسلامة الجلد/التجفاف/التداخلات.');
    if (u.pregnant) rec.push('حمل/احتمال حمل: تجنّب أدوية معيّنة؛ يُقرّر الاختصاصي.');

    switch(domain){
      case 'acne': {
        const sev = ctx.nodcys ? 'متوسط-شديد' : (ctx.inflam?'خفيف-متوسط':'خفيف/زؤاني');
        plan.push('غسل لطيف مرّتين يوميًا، تجنّب الدعك، عدم عصر البثور، منتجات غير كوميدونية.');
        if (!u.pregnant){
          if (ctx.nodcys) pharm.push('مضادّات حيوية فموية (مثال: doxycycline) لفترة محدودة + ريتينويد/بنزويل بيروكسيد موضعي — قرار الطبيب.');
          pharm.push('ريتينويد موضعي + بنزويل بيروكسيد؛ إضافة مضادّ موضعي (كلينداميسين) — قرار الطبيب.');
          pharm.push('حالات منتقاة: إيزوتريتينوين بإشراف اختصاصي (تحذيرات صارمة للحمل).');
        } else {
          pharm.push('الحمل: تجنّب الريتينويدات؛ إمكانيات محدودة (بنزويل بيروكسيد/أزيليك) — قرار طبي.');
        }
        rec.push('تقييم الندبات/العوامل الهرمونية؛ مراجعة اختصاصي عند الشدة/ندبات.');
        return {plan, rec, pharm, flags, severity:sev, assess:'حبّ شباب محتمل'};
      }
      case 'eczema': {
        if (ctx.infect) flags.push('شبهة إنتان ثانوي — قد يلزم مضاد موضعي/فموي بإشراف.');
        plan.push('ترطيب مكثّف (مرطّبات غنية، 3–4 مرات يوميًا)، حمّامات فاترة قصيرة، تجنّب الصابون المعطر/الصوف.');
        pharm.push('ستيرويد موضعي بقدرة مناسبة للموضع/العمر لمدة قصيرة — قرار الطبيب.');
        pharm.push('مثبط كالسينورين موضعي (تاكروليمس/بيميكروليمس) لمواضع حسّاسة — قرار الطبيب.');
        if (!u.pregnant) pharm.push('مضادات هيستامين لليل للحكّة؛ معالجة إنتان سطحي عند الحاجة — قرار الطبيب.');
        rec.push('خطة صيانة بعد التحسّن؛ تحديد المحفّزات/حساسية تلامسية محتملة.');
        return {plan, rec, pharm, flags, assess:'أكزيما/أتوبي محتمل'};
      }
      case 'psoriasis': {
        if (ctx.wide || ctx.arth) flags.push('انتشار واسع/مفصلي — يلزم اختصاصي؛ قد يحتاج علاج جهازي/بيولوجي.');
        plan.push('عناية بالقشور (مراهم مرطبة/سالسيلك)، تجنّب حكّة شديدة/رضوض ميكانيكية.');
        pharm.push('ستيرويد موضعي + نظير فيتامين د (كالسيبوتريول) — قرار الطبيب.');
        if (!u.pregnant) pharm.push('قطران/فوتوثيرابي؛ للحالات الشديدة أدوية جهازية (ميثوتركسات/سيكلوسبورين/بيولوجي) — قرار اختصاصي.');
        rec.push('تحرّي المتلازمات المرافقة (سمنة/متلازمة أيضية)، ومتابعة أظافر/مفاصل.');
        return {plan, rec, pharm, flags, assess:'صدفية محتملة'};
      }
      case 'urticaria': {
        if (ctx.anaph || (ctx.angio && ctx.breath)) flags.push('أعراض تأق — طارئ.');
        plan.push('تجنّب المُحرّضات المعروفة؛ ملابس قطنية؛ كمّادات باردة.');
        pharm.push('مضادّات هيستامين حديثة؛ قد تُزاد الجرعة بإشراف؛ بدائل/مُعالجات متقدمة للحالات المزمنة — قرار اختصاصي.');
        if (!u.pregnant) pharm.push('كورتيكوستيرويد قصير المدى للحالات الحادّة المختارة — قرار الطبيب.');
        rec.push('إن تكرر/استمرّ &gt;6 أسابيع — تقييم شرى مزمن.');
        return {plan, rec, pharm, flags, assess:'شرى/وذمة وعائية محتمل'};
      }
      case 'cellulitis': {
        if (ctx.necro) flags.push('شكّ نخر لفافي — طارئ.');
        const sev = (ctx.fever || ctx.lymph) ? 'متوسط/شديد' : 'خفيف';
        plan.push('علامات بقلم لمراقبة الانتشار؛ رفع الطرف المصاب؛ عناية بالجروح.');
        pharm.push('مضادّات تغطّي العقديات/المكورات العنقودية؛ إضافة تغطية MRSA حسب الخطورة — قرار الطبيب.');
        rec.push('عند الخراج — تفضّل إزالة القيح/الشّقّ تحت إشراف.');
        return {plan, rec, pharm, flags, severity:sev, assess:'التهاب نسيج خلوي/حمرة محتمل'};
      }
      case 'impetigo': {
        plan.push('نظافة موضعية، قصّ الأظافر، تجنّب الحَكّ، منع مشاركة المناشف.');
        pharm.push('مضاد موضعي (mupirocin) للبؤر المحدودة؛ فموي عند الانتشار — قرار الطبيب.');
        rec.push('استبعاد ناقلات أنفية عند النكس؛ منع العودة للمدرسة حتى 24 ساعة بعد بدء العلاج.');
        return {plan, rec, pharm, flags, assess:'قوباء محتملة'};
      }
      case 'tinea': {
        plan.push('إبقاء المنطقة جافة، تبديل جوارب متكرر، صندل مفتوح عند قدم الرياضي.');
        pharm.push('مضادات فطريات موضعية (أزولات/ألّيل أمينات مثل تيربينافين) — قرار الطبيب.');
        if (!u.pregnant) pharm.push('فموي عند الانتشار/الأظافر — قرار اختصاصي.');
        rec.push('تبديل الأحذية/تعقيم؛ معالجة المسببات في المنزل (حيوانات أليفة عند اللزوم).');
        return {plan, rec, pharm, flags, assess:'فطور جلدية محتملة'};
      }
      case 'tinea-capitis': {
        flags.push('Tinea capitis تحتاج علاجًا فمويًا — اختصاص أطفال.');
        if (ctx.kerion) flags.push('كرِيون التهابي — قد يحتاج كورتيزون قصير بإشراف.');
        plan.push('شامبو كيتوكونازول/سيلينيوم للتقليل من العدوى للآخرين، قصّ الشعر ليس ضروريًا.');
        pharm.push('فموي (غريسيوفلڤين/تيربينافين) وفق الوزن — قرار اختصاص أطفال.');
        rec.push('فحص المخالطين ومعالجة قبعات/فرش الشعر.');
        return {plan, rec, pharm, flags, assess:'فطور فروة محتملة (أطفال)'};
      }
      case 'scabies': {
        if (ctx.crust) flags.push('جرب قِرَفي/مناعي — عزل ومعالجة مكثّفة.');
        plan.push('غسل أغطية وملابس بماء ساخن وتجفيف حراري؛ معالجة جميع المخالطين بالتزامن.');
        pharm.push('Permethrin 5% موضعي وفق الإرشاد؛ تكرار بعد 7 أيام؛ حَكّة قد تستمر بعد القضاء على الطفيلي — قرار الطبيب.');
        if (!u.pregnant) pharm.push('Ivermectin فموي لبعض الحالات — قرار اختصاصي.');
        rec.push('علاج الحَكّة بمضاد هيستامين ليلي؛ ترطيب الجلد.');
        return {plan, rec, pharm, flags, assess:'جرب محتمل'};
      }
      case 'zoster': {
        if (ctx.eye) flags.push('إصابة عينية — إحالة إسعافية لطب العيون.');
        const early = ctx.early?'مبكّر ≤72ساعة':'متأخّر &gt;72ساعة';
        plan.push('عزل الآفات المغطّاة حتى التقيّح/القشور؛ مسكنات مناسبة.');
        if (!u.pregnant){
          pharm.push('مضادّات ڤيروس (acyclovir/valacyclovir) مبكّرًا — قرار الطبيب.');
          pharm.push('للألم العصبي التالي: خيارات عصبية — قرار اختصاصي.');
        }
        rec.push('النظر في اللقاح الوقائي للفئات المؤهّلة لاحقًا.');
        return {plan, rec, pharm, flags, assess:`هربس نطاقي (${early})`};
      }
      case 'hsv': {
        plan.push('تجنّب التقبيل/الاتصال خلال الطفح؛ عناية موضعية ولطّف الألم.');
        if (!u.pregnant){
          pharm.push('Acyclovir/Valacyclovir موضعي/فموي مبكّرًا — قرار الطبيب.');
        } else {
          pharm.push('الحمل: قرار اختصاصي لتقليل المخاطر حول الولادة عند التناسلي.');
        }
        rec.push('التثقيف حول العدوى الكامنة والتكرار؛ وقاية واتصال محمي عند التناسلي.');
        return {plan, rec, pharm, flags, assess:'هربس بسيط محتمل'};
      }
      case 'rosacea': {
        if (ctx.eye) flags.push('وردية عينية — تقييم عيني.');
        plan.push('تجنّب المحفّزات (حرارة/بهارات/كحول/شمس)، واقي شمسي واسع الطيف يوميًا.');
        pharm.push('Metronidazole أو Azelaic acid موضعي؛ Ivermectin موضعي للنمط الحطاطي — قرار الطبيب.');
        if (!u.pregnant) pharm.push('Doxycycline بجرعة تحت مضادّة للالتهاب لبعض الأنماط — قرار الطبيب.');
        rec.push('لعلاج الاحمرار: برومونيدين موضعي؛ للرِّينُفِيمَا — تقييم اختصاصي.');
        return {plan, rec, pharm, flags, assess:'وردية محتملة'};
      }
      case 'melanoma': {
        flags.push('آفة مشتبهة بالميلانوما — لا تؤخَّر الخزعة بحدود سليمة عبر اختصاصي.');
        plan.push('لا تحاول الإزالة المنزلية؛ تصوير توثيقي للآفة مع مسطرة؛ تحديد موعد اختصاص جلدية.');
        rec.push('ABCDEF: عدم تناظر، حدود، لون، قطر، تطوّر/نزف/حكّة، عائلي/شمسي.');
        return {plan, rec, pharm, flags, assess:'آفة مُصطبغة مشتبهة'};
      }
      case 'abscess': {
        if (ctx.faceDanger) flags.push('موضع وجهي خطير — تقييم اختصاصي لتقليل خطر الانتشار الوريدي.');
        const sev = (ctx.fever || ctx.risk) ? 'متوسط/عالٍ' : 'خفيف';
        plan.push('غالبًا العلاج الأمثل هو الشقّ والتفريغ تحت إشراف؛ كمّادات دافئة قبل الإجراء.');
        pharm.push('مضادّات تغطّي MRSA عند الحاجة/حسب الخطورة — قرار الطبيب.');
        rec.push('عناية بالجروح وتبديل الضماد؛ مراقبة علامات الانتشار.');
        return {plan, rec, pharm, flags, severity:sev, assess:'خراج/دمّل محتمل'};
      }
    }
    return {plan, rec, pharm, flags};
  }

  // ====== عرض موحّد ======
  function showResult(elId, obj){
    const u = userContext();
    const header = `<p>الاسم: <b>${u.name}</b>${u.age!=null? ` — العمر: <b>${u.age}</b>`:''} — الجنس: <b>${u.sex.label}</b></p>`;
    const assess = obj.assess ? `<p><b>التقييم:</b> ${obj.assess}</p>` : '';
    const sev = obj.severity ? `<p><b>الشدة:</b> ${obj.severity}</p>` : '';
    const score = (obj.score!==undefined) ? `<p><b>قيمة/درجة:</b> ${obj.score}</p>` : '';
    const flagsHtml = obj.flags?.length? `<p><b>تنبيهات:</b></p>${lines(obj.flags)}` : '';
    const planHtml = obj.plan?.length? `<p><b>خطة عامة:</b></p>${lines(obj.plan)}` : '';
    const recHtml = obj.rec?.length? `<p><b>توصيات موجّهة:</b></p>${lines(obj.rec)}` : '';
    const pharmHtml = obj.pharm?.length? `<p><b>أمثلة أدوية (قرار الطبيب):</b></p>${lines(obj.pharm)}<p class="hint">لا تبدأ/توقف أي دواء دون طبيب. اعتبارات خاصة للحمل/الأطفال/كبار السن.</p>` : '';
    document.getElementById(elId).innerHTML = header + score + sev + assess + flagsHtml + planHtml + recHtml + pharmHtml;
    setLast({...obj, user:u});
  }

  // ====== الحسابات ======
  function calcAcne(){
    const com=yes('acComed'), infl=yes('acInflam'), nod=yes('acNodCys');
    const {plan, rec, pharm, flags, severity, assess} = buildPlanDerm('acne', {inflam:infl, nodcys:nod}, userContext());
    showResult('acne-res', {title:'حبّ الشباب', assess, severity, plan, rec, pharm, flags});
  }
  function calcEczema(){
    const itch=yes('ecItchDry'), er=yes('ecErupt'), trg=yes('ecTriggers'), inf=yes('ecInfect');
    const {plan, rec, pharm, flags, assess} = buildPlanDerm('eczema', {infect:inf}, userContext());
    showResult('eczema-res', {title:'إكزيما', assess, plan, rec, pharm, flags});
  }
  function calcPsoriasis(){
    const pl=yes('psPlaque'), na=yes('psNail'), ar=yes('psArth'), wi=yes('psWide');
    const {plan, rec, pharm, flags, assess} = buildPlanDerm('psoriasis', {arth:ar, wide:wi}, userContext());
    showResult('psoriasis-res', {title:'صدفية', assess, plan, rec, pharm, flags});
  }
  function calcUrticaria(){
    const hi=yes('urHives'), an=yes('urAngio'), aa=yes('urAnaph'), tr=yes('urTrigger');
    const {plan, rec, pharm, flags, assess} = buildPlanDerm('urticaria', {angio:an, anaph:aa, breath:aa}, userContext());
    showResult('urticaria-res', {title:'شرى/وذمة', assess, plan, rec, pharm, flags});
  }
  function calcCellulitis(){
    const ba=yes('ceBasic'), ly=yes('ceLymph'), fe=yes('ceFever'), ne=yes('ceNecro');
    const {plan, rec, pharm, flags, assess, severity} = buildPlanDerm('cellulitis', {fever:fe, lymph:ly, necro:ne}, userContext());
    showResult('cellulitis-res', {title:'التهاب نسيج خلوي/حمرة', assess, severity, plan, rec, pharm, flags});
  }
  function calcImpetigo(){
    const ho=yes('imHoney'), sp=yes('imSpread');
    const {plan, rec, pharm, flags, assess} = buildPlanDerm('impetigo', {}, userContext());
    showResult('impetigo-res', {title:'قوباء', assess, plan, rec, pharm, flags});
  }
  function calcTinea(){
    const ri=yes('tiRing'), it=yes('tiItch');
    const {plan, rec, pharm, flags, assess} = buildPlanDerm('tinea', {}, userContext());
    showResult('tinea-res', {title:'فطور جلدية', assess, plan, rec, pharm, flags});
  }
  function calcTineaCapitis(){
    const sc=yes('tcScale'), ke=yes('tcKerion');
    const {plan, rec, pharm, flags, assess} = buildPlanDerm('tinea-capitis', {kerion:ke}, userContext());
    showResult('tinea-capitis-res', {title:'فطور فروة (أطفال)', assess, plan, rec, pharm, flags});
  }
  function calcScabies(){
    const ni=yes('scNight'), bu=yes('scBurrow'), ho=yes('scHouse'), cr=yes('scCrust');
    const {plan, rec, pharm, flags, assess} = buildPlanDerm('scabies', {crust:cr}, userContext());
    showResult('scabies-res', {title:'جرب', assess, plan, rec, pharm, flags});
  }
  function calcZoster(){
    const de=yes('zoDerm'), ey=yes('zoEye'), ea=yes('zoEarly'), ri=yes('zoRisk');
    const {plan, rec, pharm, flags, assess} = buildPlanDerm('zoster', {eye:ey, early:ea}, userContext());
    showResult('zoster-res', {title:'هربس نطاقي', assess, plan, rec, pharm, flags});
  }
  function calcHSV(){
    const ve=yes('hsVes'), re=yes('hsRec'), ge=yes('hsGen'), ri=yes('hsRisk');
    const {plan, rec, pharm, flags, assess} = buildPlanDerm('hsv', {}, userContext());
    showResult('hsv-res', {title:'هربس بسيط', assess, plan, rec, pharm, flags});
  }
  function calcRosacea(){
    const fa=yes('roFace'), tr=yes('roTrigger'), rh=yes('roRhin'), ey=yes('roEye');
    const {plan, rec, pharm, flags, assess} = buildPlanDerm('rosacea', {eye:ey}, userContext());
    showResult('rosacea-res', {title:'وردية', assess, plan, rec, pharm, flags});
  }
  function calcMelanoma(){
    const ab=yes('meAsyBor'), co=yes('meColor'), si=yes('meSize'), ev=yes('meEvol');
    const {plan, rec, pharm, flags, assess} = buildPlanDerm('melanoma', {}, userContext());
    showResult('melanoma-res', {title:'آفة مُصطبغة مشتبهة', assess, plan, rec, pharm, flags});
  }
  function calcAbscess(){
    const fl=yes('abFluct'), fe=yes('abFever'), da=yes('abDanger'), ri=yes('abRisk');
    const {plan, rec, pharm, flags, assess, severity} = buildPlanDerm('abscess', {fever:fe, risk:ri, faceDanger:da}, userContext());
    showResult('abscess-res', {title:'خراج/دمّل', assess, severity, plan, rec, pharm, flags});
  }

  // ====== PDF ======
  async function exportPDF(section){
    const { jsPDF } = window.jspdf;
    const m = window._last || {title:section, user:userContext(), plan:[], rec:[], pharm:[], flags:[]};
    const u = m.user || userContext();

    const box = document.createElement('div');
    box.dir = 'rtl';
    box.style.cssText = 'width:800px;padding:24px;background:#fff;color:#111;font-family:Cairo,Arial,sans-serif;line-height:1.9;border:1px solid #ddd;border-radius:12px';
    box.innerHTML = `
      <h2 style="margin:0 0 10px;font-weight:800">حكيم — ${m.title||section}</h2>
      <p><b>الاسم:</b> ${u.name || 'بدون اسم'}${u.age!=null? ` — <b>العمر:</b> ${u.age}`:''} — <b>الجنس:</b> ${u.sex? u.sex.label : 'غير محدد'}</p>
      ${m.score!==undefined? `<p><b>قيمة/درجة:</b> ${m.score}</p>`:''}
      ${m.severity? `<p><b>الشدة:</b> ${m.severity}</p>`:''}
      ${m.assess? `<p><b>التقييم:</b> ${m.assess}</p>`:''}
      ${m.flags && m.flags.length? `<p><b>تنبيهات:</b></p><ul>${m.flags.map(x=>`<li>${x}</li>`).join('')}</ul>`:''}
      ${m.plan && m.plan.length? `<p><b>خطة عامة:</b></p><ul>${m.plan.map(x=>`<li>${x}</li>`).join('')}</ul>`:''}
      ${m.rec && m.rec.length? `<p><b>توصيات موجّهة:</b></p><ul>${m.rec.map(x=>`<li>${x}</li>`).join('')}</ul>`:''}
      ${m.pharm && m.pharm.length? `<p><b>أمثلة دوائية (قرار الطبيب):</b></p><ul>${m.pharm.map(x=>`<li>${x}</li>`).join('')}</ul><p style="font-size:12px;color:#555">تنبيه: لا تبدأ/توقف أي دواء دون طبيب. اعتبارات خاصة للحمل/الأطفال/كبار السن.</p>`:''}
      <hr style="margin:12px 0;border:0;border-top:1px solid #ddd"/>
      <p style="font-size:13px;color:#444">ملف تثقيفي — لا يُغني عن تقييم الطبيب المختص. في الطوارئ يُرجى التواصل الفوري مع الإسعاف.</p>
    `;
    document.body.appendChild(box);
    const canvas = await html2canvas(box, {scale:2, backgroundColor:'#ffffff', useCORS:true});
    document.body.removeChild(box);

    const pdf = new jsPDF({orientation:'p', unit:'pt', format:'a4'});
    const pageW = pdf.internal.pageSize.getWidth(), pageH = pdf.internal.pageSize.getHeight(), margin=40;
    let imgW = pageW - margin*2, imgH = canvas.height * imgW / canvas.width;
    if (imgH > pageH - margin*2){ const r = (pageH - margin*2) / imgH; imgH*=r; imgW*=r; }
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', (pageW-imgW)/2, (pageH-imgH)/2, imgW, imgH);
    pdf.save(`Hakim-Derm-${(m.title||section).replace(/\s+/g,'_')}-${Date.now()}.pdf`);
  }
</script>

<!--
  الأقسام: حب الشباب، إكزيما، صدفية، شرى/وذمة، التهاب نسيج خلوي/حمرة، قوباء،
  فطور جلدية، فطور فروة (أطفال)، جرب، هربس نطاقي، هربس بسيط، وردية،
  آفة مُصطبغة (ABCDE)، خراج/دمّل.
  أمثلة أدوية دون جرعات وبصيغة "قرار الطبيب" التزامًا بالسلامة.
-->
</body>
</html>
