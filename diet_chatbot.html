<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„ØªØºØ°ÙŠØ© Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø³ÙˆØ±ÙŠØ©</title>
<style>
  :root{
    --bg:#0f172a;        /* slate-900 */
    --panel:#111827;     /* gray-900 */
    --muted:#94a3b8;     /* slate-400 */
    --text:#e5e7eb;      /* gray-200 */
    --accent:#22c55e;    /* green-500 */
    --accent-2:#06b6d4;  /* cyan-500 */
    --danger:#ef4444;    /* red-500 */
    --card:#0b1220;
    --border:#1f2937;
    --chip:#1e293b;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(135deg,#0b1020,#0e1224 45%,#0b1424);
    color:var(--text); font:16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Tajawal", Arial, sans-serif;
    min-height:100svh; display:flex; align-items:center; justify-content:center; padding:20px;
  }
  .app{
    width:min(1000px,100%); background:rgba(17,24,39,.65); border:1px solid var(--border);
    border-radius:20px; overflow:hidden; box-shadow:0 10px 35px rgba(0,0,0,.35), inset 0 0 180px rgba(34,197,94,.05);
    backdrop-filter: blur(6px);
  }
  header{
    padding:14px 18px; display:flex; gap:14px; align-items:center; border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(34,197,94,.09), transparent);
  }
  .logo{
    width:40px; height:40px; display:grid; place-items:center; border-radius:12px; background:radial-gradient(55% 55% at 50% 50%, rgba(34,197,94,.2), rgba(6,182,212,.15));
    border:1px solid var(--border);
  }
  h1{font-size:18px; margin:0}
  .sub{color:var(--muted); font-size:13px}
  .controls{margin-inline-start:auto; display:flex; gap:10px; flex-wrap:wrap}
  .select, .btn{
    appearance:none; border:1px solid var(--border); background:var(--chip); color:var(--text);
    padding:10px 12px; border-radius:12px; font:inherit;
  }
  .btn{background:linear-gradient(180deg, #1f2937, #111827); cursor:pointer; transition:.2s ease; border:1px solid #263244}
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(180deg, #16a34a, #15803d); border-color:#166534}
  .btn.secondary{background:linear-gradient(180deg, #0891b2, #0e7490); border-color:#155e75}
  .btn.ghost{background:var(--chip)}
  .btn:disabled{opacity:.5; cursor:not-allowed; transform:none}
  main{display:grid; grid-template-rows:auto 1fr auto; height:min(72svh,640px)}
  .chat{
    padding:14px; overflow:auto; background:
      radial-gradient(1000px 420px at 100% 0%, rgba(6,182,212,.05), transparent),
      radial-gradient(800px 360px at 0% 0%, rgba(34,197,94,.06), transparent);
  }
  .msg{display:flex; gap:10px; margin:10px 0; align-items:flex-start}
  .msg .avatar{
    width:36px; height:36px; flex:none; display:grid; place-items:center; border-radius:10px; background:var(--panel); border:1px solid var(--border);
  }
  .bubble{
    background:var(--card); border:1px solid var(--border); padding:10px 12px; border-radius:14px; max-width:85%;
    box-shadow:0 6px 16px rgba(0,0,0,.18);
    white-space:pre-wrap;
  }
  .me .bubble{background:linear-gradient(180deg,#0f172a,#0b1322); border-color:#213048}
  .bot .bubble{background:linear-gradient(180deg,#0a1424,#0b1628); border-color:#22324a}
  .meta{font-size:12px; color:var(--muted); margin-top:4px}
  .composer{display:flex; gap:10px; padding:12px; border-top:1px solid var(--border); background:rgba(15,23,42,.6)}
  .input{
    flex:1; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0b1220; color:var(--text);
  }
  .plan-box{
    margin-top:10px; padding:12px; border-radius:12px; background:rgba(34,197,94,.06); border:1px dashed #1f8f55;
  }
  .chips{display:flex; gap:6px; flex-wrap:wrap}
  .chip{font-size:12px; padding:6px 8px; border:1px solid var(--border); border-radius:999px; background:var(--chip); color:var(--text)}
  footer{padding:10px 16px; font-size:12px; color:var(--muted)}
  @media (max-width:640px){
    header{flex-wrap:wrap; gap:8px}
    .controls{width:100%}
  }
</style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="logo">ğŸ§®</div>
      <div>
        <h1>Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„ØªØºØ°ÙŠØ©</h1>
        <div class="sub">Ø¨ÙŠØ­ÙƒÙŠ Ø³ÙˆØ±ÙŠ â€” Ø¨ÙŠØ³Ø£Ù„Ùƒ ÙƒØ§Ù… Ø³Ø¤Ø§Ù„ ÙˆØ¨ÙŠØ±ÙƒÙ‘Ø¨ Ø®Ø·Ø© <span style="color:#86efac">ØªÙ†Ø­ÙŠÙ</span> Ø£Ùˆ <span style="color:#67e8f9">ØªØ³Ù…ÙŠÙ†</span></div>
      </div>
      <div class="controls">
        <label class="chip">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:
          <select id="qCount" class="select">
            <option value="10" selected>10</option>
            <option value="20">20</option>
          </select>
        </label>
        <label class="chip">Ø§Ù„Ù‡Ø¯Ù:
          <select id="goal" class="select">
            <option>ØªÙ†Ø­ÙŠÙ</option>
            <option>ØªØ³Ù…ÙŠÙ†</option>
          </select>
        </label>
        <button class="btn primary" id="startBtn">Ø¨Ù„Ù‘Ø´ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
        <button class="btn ghost" id="resetBtn" disabled>Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
        <button class="btn secondary" id="saveBtn" disabled>Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø© TXT</button>
      </div>
    </header>

    <main>
      <div class="chat" id="chat"></div>

      <div class="composer">
        <input id="input" class="input" type="text" placeholder="Ø§ÙƒØªØ¨ Ø¬ÙˆØ§Ø¨Ùƒ Ù‡ÙˆÙ† ÙˆØ§Ø¶ØºØ· Enterâ€¦" disabled />
        <button class="btn" id="sendBtn" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
      <footer>ØªØ°ÙƒÙŠØ±: Ù‡Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø¥Ø±Ø´Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù…ØŒ Ù…Ùˆ Ø¨Ø¯ÙŠÙ„ Ø¹Ù† Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø®ØªØµ Ø®ØµÙˆØµÙŠ Ø¨ÙˆØ¬ÙˆØ¯ Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©.</footer>
    </main>
  </div>

<script>
/* ---------- Utilities ---------- */
const $ = sel => document.querySelector(sel);
const chat = $("#chat");
const input = $("#input");
const sendBtn = $("#sendBtn");
const startBtn = $("#startBtn");
const resetBtn = $("#resetBtn");
const saveBtn = $("#saveBtn");
const qCountSel = $("#qCount");
const goalSel = $("#goal");

function nowTime(){ const d = new Date(); return d.toLocaleTimeString('ar', {hour:'2-digit', minute:'2-digit'}); }
function addMsg(who, text, extraHtml=null){
  const wrap = document.createElement("div");
  wrap.className = "msg " + (who === "bot" ? "bot" : "me");
  wrap.innerHTML = `
    <div class="avatar">${who==="bot"?"ğŸ¤–":"ğŸ‘¤"}</div>
    <div class="bubble">
      ${text.replace(/\n/g,'<br>')}
      ${extraHtml? `<div class="plan-box">${extraHtml}</div>`: ""}
      <div class="meta">${who==="bot"?"Ø§Ù„Ø¨ÙˆØª":"Ø¥Ù†Øª"} â€¢ ${nowTime()}</div>
    </div>`;
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
}

const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
const parseNum = (v, def=null) => {
  if (v==null) return def;
  const n = parseFloat(String(v).replace(",", "."));
  return Number.isFinite(n) ? n : def;
};
const r = (x, n=0) => Number.isFinite(x) ? (Math.round(x*10**n)/10**n) : x;

function mifflinStJeor(sex, weight, height, age){
  return (sex === "Ø£Ù†Ø«Ù‰")
    ? 10*weight + 6.25*height - 5*age - 161
    : 10*weight + 6.25*height - 5*age + 5;
}
function activityFactor(level){
  const map = { "Ù‚Ù„ÙŠÙ„ ÙƒØªÙŠØ±":1.2, "Ø®ÙÙŠÙ":1.375, "Ù…ØªÙˆØ³Ø·":1.55, "Ø¹Ø§Ù„":1.725, "Ø¹Ø§Ù„ Ø¬Ø¯Ø§Ù‹":1.9 };
  return map[level] ?? 1.2;
}

/* ---------- Questions Pool (20) ---------- */
const pool = [
  ["Ø§Ù„Ø§Ø³Ù…", "Ø®Ø¨Ø±Ù†ÙŠ Ø¨Ø§Ø³Ù…ÙƒØŸ"],
  ["Ø§Ù„Ø¹Ù…Ø±", "Ù‚Ø¯Ù‘ÙŠ Ø¹Ù…Ø±ÙƒØŸ (Ø¨Ø§Ù„Ø³Ù†ÙŠÙ†)"],
  ["Ø§Ù„Ø·ÙˆÙ„", "Ù‚Ø¯Ù‘ÙŠØ´ Ø·ÙˆÙ„Ùƒ Ø¨Ø§Ù„Ø³Ù†ØªÙŠÙ…ØªØ±ØŸ"],
  ["Ø§Ù„ÙˆØ²Ù†", "Ù‚Ø¯Ù‘ÙŠØ´ ÙˆØ²Ù†Ùƒ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆØŸ"],
  ["Ø§Ù„Ø¬Ù†Ø³", "Ø°ÙƒÙØ± ÙˆÙ„Ø§ Ø£Ù†Ø«Ù‰ØŸ (Ø§ÙƒØªØ¨: Ø°ÙƒØ± / Ø£Ù†Ø«Ù‰)"],
  ["Ù†Ø´Ø§Ø·", "Ù‚Ø¯Ù‘ÙŠØ´ Ù†Ø´Ø§Ø·Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØŸ (Ù‚Ù„ÙŠÙ„ ÙƒØªÙŠØ±/Ø®ÙÙŠÙ/Ù…ØªÙˆØ³Ø·/Ø¹Ø§Ù„/Ø¹Ø§Ù„ Ø¬Ø¯Ø§Ù‹)"],
  ["Ù‡Ø¯Ù_Ø¯Ù‚ÙŠÙ‚", "Ø¨Ø¯Ù‘Ùƒ ØªÙ†Ø­Ù‘Ù ÙˆÙ„Ø§ ØªØ³Ù…Ù†ØŸ (ØªÙ†Ø­ÙŠÙ/ØªØ³Ù…ÙŠÙ†) Ø¥Ø°Ø§ Ù…Ùˆ Ù…ØªØ£ÙƒØ¯ Ø®Ù„Ù‘ÙŠÙ†ÙŠ Ù‚Ø±Ø± Ù…Ù† BMI."],
  ["Ø³Ø±Ø¹Ø©", "Ø­Ø§Ø¨/Ø­Ø§Ø¨Ø© ØªÙ…Ø´ÙŠ Ø¨Ø³Ø±Ø¹Ø© ÙˆÙ„Ø§ Ø¹Ù„Ù‰ Ù…Ù‡Ù„ÙƒØŸ (Ø³Ø±ÙŠØ¹/Ù…ØªÙˆØ³Ø·/Ù‡Ø§Ø¯Ø¦)"],
  ["Ø£Ù…Ø±Ø§Ø¶", "ÙÙŠ Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø© Ø£Ùˆ Ø£Ø¯ÙˆÙŠØ© Ù…Ù‡Ù…Ù‘Ø©ØŸ (Ø¥Ø°Ø§ Ù„Ø§ Ø§ÙƒØªØ¨: Ù„Ø§)"],
  ["Ø­Ø³Ø§Ø³ÙŠØ©", "Ø¹Ù†Ø¯Ùƒ ØªØ­Ø³Ù‘Ø³ Ù…Ù† Ø£ÙƒÙ„ Ù…Ø¹ÙŠÙ‘Ù†ØŸ (Ø§ÙƒØªØ¨ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¥Ù† ÙˆÙØ¬Ø¯Øª)"],
  ["Ù†Ø¸Ø§Ù…_ØºØ°Ø§Ø¦ÙŠ", "Ø¨ØªÙØ¶Ù‘Ù„ Ø£ÙƒÙ„ Ø¹Ø§Ø¯ÙŠ ÙˆÙ„Ø§ Ù†Ø¨Ø§ØªÙŠ ÙˆÙ„Ø§ Ù†Ø¨Ø§ØªÙŠ-Ø¨ÙŠØ³Ù…Ùƒ (Ø¨Ø³ÙƒÙŠØªØ§Ø±ÙŠ)ØŸ"],
  ["ÙˆØ¬Ø¨Ø§Øª", "ÙƒÙ… ÙˆØ¬Ø¨Ø© Ù†Ø§ÙˆÙŠ/Ø© ØªØ£ÙƒÙ„ Ø¨Ø§Ù„ÙŠÙˆÙ…ØŸ (Ù…Ø«Ù„Ø§Ù‹ 3 Ø±Ø¦ÙŠØ³ÙŠØ© + 1 Ø³Ù†Ø§Ùƒ)"],
  ["Ù…Ø§Ø¡", "Ù‚Ø¯Ù‘ÙŠØ´ Ø¨ØªØ´Ø±Ø¨ Ù…ÙŠ Ø¨Ø§Ù„ÙŠÙˆÙ… ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ØŸ (Ù„ØªØ±)"],
  ["Ù†ÙˆÙ…", "Ù‚Ø¯Ù‘ÙŠØ´ Ø³Ø§Ø¹Ø§Øª Ù†ÙˆÙ…ÙƒØŸ"],
  ["ØªÙ…Ø§Ø±ÙŠÙ†", "Ø¨ØªÙ‚Ø¯Ø± ØªØªÙ…Ø±Ù‘Ù†ØŸ (Ø¨ÙŠØª/Ù†Ø§Ø¯ÙŠ/Ù…Ø´ÙŠ/Ù„Ø§)"],
  ["Ø®Ø·ÙˆØ§Øª", "Ù…ØªÙˆØ³Ø· Ø®Ø·ÙˆØ§ØªÙƒ Ø¨Ø§Ù„ÙŠÙˆÙ…ØŸ (Ø¥Ø°Ø§ Ù…Ø§ Ø¨ØªØ¹Ø±Ù ØªÙ‚Ø¯ÙŠØ± ØªÙ‚Ø±ÙŠØ¨ÙŠ)"],
  ["ØµÙˆÙ…", "Ø¨ØªØµÙˆÙ… Ù…ØªÙ‚Ø·Ø¹ Ø£Ùˆ ØµÙˆÙ… Ø¯ÙŠÙ†ÙŠ Ø¨ÙŠØ£Ø«Ù‘Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬Ø¨Ø§ØªØŸ (Ù†Ø¹Ù…/Ù„Ø§ + ØªÙØ§ØµÙŠÙ„)"],
  ["ÙˆÙ‚Øª_Ø·Ø¨Ø®", "Ù‚Ø¯Ù‘ÙŠØ´ Ø¹Ù†Ø¯Ùƒ ÙˆÙ‚Øª Ù„Ù„Ø·Ø¨Ø® ÙŠÙˆÙ…ÙŠØ§Ù‹ØŸ (Ù‚ØµÙŠØ±/Ù…ØªÙˆØ³Ø·/Ù…Ø±ØªØ§Ø­)"],
  ["Ù…ÙŠØ²Ø§Ù†ÙŠØ©", "Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ù„Ù„Ø£ÙƒÙ„ Ø§Ù„ØµØ­ÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ØŸ (Ù…Ù†Ø®ÙØ¶Ø©/Ù…ØªÙˆØ³Ø·Ø©/Ù…Ø±ØªÙØ¹Ø©)"],
  ["Ø£Ø°ÙˆØ§Ù‚", "Ø£ÙƒÙ„Ø§Øª Ø¨ØªØ­Ø¨Ù‡Ø§ Ø£Ùˆ Ø¨ØªØ­Ø¨ ØªØªØ¬Ù†Ù‘Ø¨Ù‡Ø§ØŸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"],
];

/* ---------- State ---------- */
let questions = [];
let answers = {};
let currentIdx = -1;
let planText = "";

/* ---------- Flow ---------- */
function welcome(){
  addMsg("bot", "Ø£Ù‡Ù„Ø§ ÙˆØ³Ù‡Ù„Ø§! Ø£Ù†Ø§ Ø´Ø§Øª Ø¨ÙˆØª ØªØºØ°ÙŠØ© Ø¹Ø§Ù„Ø®ÙÙŠÙØŒ Ø¨Ø­ÙƒÙŠ Ù…Ø¹Ùƒ Ø¨Ø§Ù„Ù„Ù‡Ø¬Ø© Ø§Ù„Ø³ÙˆØ±ÙŠØ©. ğŸ‘‹");
  addMsg("bot", "Ø§Ø®ØªØ§Ø± Ù…Ù† ÙÙˆÙ‚ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ­Ø¯Ù‘Ø¯ Ù‡Ø¯ÙÙƒØŒ ÙˆØ¨Ø³ ØªØ¶ØºØ· Â«Ø¨Ù„Ù‘Ø´ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©Â» Ù…Ù†Ù…Ø´ÙŠ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.");
}
welcome();

function startChat(){
  const n = (qCountSel.value === "20") ? 20 : 10;
  questions = pool.slice(0, n);
  answers = {"Ø§Ù„Ù‡Ø¯Ù_Ù…Ø¨Ø¯Ø¦ÙŠ": goalSel.value};
  currentIdx = -1;
  planText = "";
  chat.innerHTML = "";
  addMsg("bot", "ÙŠÙ„Ø§ Ù†Ø¨Ù„Ù‘Ø´! Ø¬Ø§ÙˆØ¨ Ø¨Ø£Ù‚ØµØ± Ø´ÙƒÙ„ Ù…Ù…ÙƒÙ†ØŒ ÙˆØ¥Ø°Ø§ Ù…Ø§ Ø¨ØªØ¹Ø±Ù Ø§ÙƒØªØ¨ ØªÙ‚Ø¯ÙŠØ±ÙŠ.");

  input.disabled = false; sendBtn.disabled = false;
  startBtn.disabled = true; resetBtn.disabled = false; saveBtn.disabled = true;
  askNext();
}

function askNext(){
  currentIdx += 1;
  if(currentIdx < questions.length){
    const [, q] = questions[currentIdx];
    addMsg("bot", q);
  } else {
    finishAndPlan();
  }
}

function onSend(){
  const msg = input.value.trim();
  if(!msg) return;
  addMsg("me", msg);
  const [key] = questions[currentIdx];
  answers[key] = msg;
  input.value = "";
  setTimeout(askNext, 200);
}

function resetAll(){
  questions = [];
  answers = {};
  currentIdx = -1;
  planText = "";
  chat.innerHTML = "";
  welcome();
  input.disabled = true; sendBtn.disabled = true;
  startBtn.disabled = false; resetBtn.disabled = true; saveBtn.disabled = true;
}

function savePlan(){
  if(!planText) return;
  const blob = new Blob([planText], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Ø®Ø·Ø©_ØªØºØ°ÙŠØ©.txt";
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
}

/* ---------- Planning ---------- */
function mealOptions(dietType, goalType, budgetLevel){
  let base;
  const d = (dietType||"").toLowerCase();
  if(d.includes("Ù†Ø¨Ø§ØªÙŠ") && !d.includes("Ø¨Ø³Ù…Ùƒ") && !d.includes("Ø¨ÙŠØ³Ù…Ùƒ")){
    base = [
      "ÙØ·ÙˆØ±: Ø´ÙˆÙØ§Ù† Ø¨Ø­Ù„ÙŠØ¨ Ù†Ø¨Ø§ØªÙŠ + Ù…ÙˆØ² + Ù…ÙƒØ³Ø±Ø§Øª",
      "ØºØ¯Ø§Ø¡: Ø¹Ø¯Ø³/ÙØ§ØµÙˆÙ„ÙŠØ§ Ù…Ø¹ Ø±Ø² ÙˆØ®Ø¶Ø§Ø± Ø³ÙˆØªÙŠÙ‡",
      "Ø¹Ø´Ø§Ø¡: Ø³Ù„Ø·Ø© ÙƒØ¨ÙŠØ±Ø© Ù…Ø¹ Ø­Ù…Øµ/ÙÙˆÙ„ + Ø®Ø¨Ø² Ø£Ø³Ù…Ø±",
      "Ø³Ù†Ø§Ùƒ: ÙÙˆØ§ÙƒÙ‡/Ù„Ø¨Ù†Ø© Ù†Ø¨Ø§ØªÙŠØ©/Ù…ÙƒØ³Ø±Ø§Øª"
    ];
  } else if(d.includes("Ø¨Ø³Ù…Ùƒ") || d.includes("Ø¨ÙŠØ³Ù…Ùƒ")){
    base = [
      "ÙØ·ÙˆØ±: Ø¨ÙŠØ¶ØªÙŠÙ† + Ø®Ø¨Ø² Ø£Ø³Ù…Ø± + Ø®Ø¶Ø§Ø±",
      "ØºØ¯Ø§Ø¡: Ø³Ù…Ùƒ Ù…Ø´ÙˆÙŠ + Ø±Ø² + Ø³Ù„Ø·Ø©",
      "Ø¹Ø´Ø§Ø¡: ØªÙˆÙ†Ø© Ù„Ø§ÙŠØª + Ø°Ø±Ø© + Ø®Ø¶Ø§Ø± ÙˆØ±Ù‚ÙŠØ©",
      "Ø³Ù†Ø§Ùƒ: Ù„Ø¨Ù†/Ù„Ø¨Ù†Ø© + Ø®ÙŠØ§Ø± Ø£Ùˆ Ù…ÙƒØ³Ø±Ø§Øª"
    ];
  } else {
    base = [
      "ÙØ·ÙˆØ±: Ø¨ÙŠØ¶ØªÙŠÙ†/Ù„Ø¨Ù†Ø© + Ø®Ø¨Ø² Ø¹Ø±Ø¨ÙŠ Ø£Ø³Ù…Ø± + Ø®Ø¶Ø§Ø±",
      "ØºØ¯Ø§Ø¡: Ø¯Ø¬Ø§Ø¬/Ù„Ø­Ù… Ù…Ø´ÙˆÙŠ + Ø±Ø² Ø£Ùˆ Ø¨Ø±ØºÙ„ + Ø³Ù„Ø·Ø©",
      "Ø¹Ø´Ø§Ø¡: Ù„Ø¨Ù†/Ø¬Ø¨Ù†Ø© + Ø®Ø¶Ø§Ø± + Ø®Ø¨Ø² Ø£Ø³Ù…Ø±",
      "Ø³Ù†Ø§Ùƒ: ÙÙˆØ§ÙƒÙ‡/Ù…ÙƒØ³Ø±Ø§Øª/Ø²Ø¨Ø§Ø¯ÙŠ"
    ];
  }

  const tips = (goalType==="ØªÙ†Ø­ÙŠÙ")
    ? "Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø­ØµØµ Ø£ØµØºØ±ØŒ Ø®ÙÙ‘Ø¶ Ø§Ù„Ø²ÙŠÙˆØªØŒ ÙˆØ²Ù‘Ø¹ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† Ø¹Ø§Ù„ÙˆØ¬Ø¨Ø§Øª."
    : "ÙƒØ¨Ù‘Ø± Ø§Ù„Ø­ØµØµ ØªØ¯Ø±ÙŠØ¬ÙŠØŒ Ø²ÙŠØ¯ ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª Ù…Ø¹ ÙƒÙ„ ÙˆØ¬Ø¨Ø©ØŒ ÙˆØ±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†.";

  let extra;
  if((budgetLevel||"").includes("Ù…Ù†Ø®ÙØ¶Ø©")) extra = "Ø¨Ø¯Ø§Ø¦Ù„ Ø£ÙˆÙØ±: ÙÙˆÙ„/Ø­Ù…Øµ/Ø¹Ø¯Ø³ØŒ Ø±Ø²/Ø¨Ø±ØºÙ„ØŒ Ø¨ÙŠØ¶ØŒ Ø®Ø¶Ø§Ø± Ù…ÙˆØ³Ù…ÙŠØ©.";
  else if((budgetLevel||"").includes("Ù…Ø±ØªÙØ¹Ø©")) extra = "Ù…Ù…ÙƒÙ† ØªØ¶ÙŠÙ: Ø³Ù„Ù…ÙˆÙ†ØŒ Ù„Ø­Ù… Ø®Ø§Ù„ÙŠ Ø¯Ù‡Ù†ØŒ Ø£ÙÙˆÙƒØ§Ø¯ÙˆØŒ ØªÙˆØª.";
  else extra = "Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ ØªÙ†ÙˆÙŠØ¹ Ù…Ø¹ØªØ¯Ù„ Ø¶Ù…Ù† Ø§Ù„Ù…ØªØ§Ø­.";

  return {base, tips, extra};
}

function finishAndPlan(){
  const name   = answers["Ø§Ù„Ø§Ø³Ù…"] || "ØµØ¯ÙŠÙ‚Ù†Ø§/ØµØ¯ÙŠÙ‚ØªÙ†Ø§";
  const age    = parseNum(answers["Ø§Ù„Ø¹Ù…Ø±"], 30);
  const height = parseNum(answers["Ø§Ù„Ø·ÙˆÙ„"], 170);
  const weight = parseNum(answers["Ø§Ù„ÙˆØ²Ù†"], 75);
  let sex      = (answers["Ø§Ù„Ø¬Ù†Ø³"]||"Ø°ÙƒØ±").trim();
  sex = sex.includes("Ø£Ù†Ø«") || sex.includes("Ø§Ù†Ø«") ? "Ø£Ù†Ø«Ù‰" : (sex.includes("Ø°Ùƒ") ? "Ø°ÙƒØ±" : "Ø°ÙƒØ±");
  const act    = answers["Ù†Ø´Ø§Ø·"] || "Ø®ÙÙŠÙ";
  const preciseGoal = (answers["Ù‡Ø¯Ù_Ø¯Ù‚ÙŠÙ‚"]||"").trim();
  const initialGoal = answers["Ø§Ù„Ù‡Ø¯Ù_Ù…Ø¨Ø¯Ø¦ÙŠ"] || "ØªÙ†Ø­ÙŠÙ";
  const goal   = preciseGoal.includes("ØªÙ†Ø­") || preciseGoal.includes("Ù†Ø­Ù") ? "ØªÙ†Ø­ÙŠÙ"
               : preciseGoal.includes("ØªØ³Ù…") ? "ØªØ³Ù…ÙŠÙ†"
               : initialGoal;

  const speed  = answers["Ø³Ø±Ø¹Ø©"] || "Ù…ØªÙˆØ³Ø·";
  const conds  = answers["Ø£Ù…Ø±Ø§Ø¶"] || "Ù„Ø§";
  const allergy = (answers["Ø­Ø³Ø§Ø³ÙŠØ©"]||"").trim();
  const diet   = (answers["Ù†Ø¸Ø§Ù…_ØºØ°Ø§Ø¦ÙŠ"]||"Ø¹Ø§Ø¯ÙŠ");
  const meals  = answers["ÙˆØ¬Ø¨Ø§Øª"] || "3 + 1 Ø³Ù†Ø§Ùƒ";
  const waterL = parseNum(answers["Ù…Ø§Ø¡"], 2.0);
  const sleepH = parseNum(answers["Ù†ÙˆÙ…"], 7.0);
  const place  = (answers["ØªÙ…Ø§Ø±ÙŠÙ†"]||"Ù…Ø´ÙŠ").toLowerCase();
  const steps  = parseNum(answers["Ø®Ø·ÙˆØ§Øª"], 5000);
  const fasting = answers["ØµÙˆÙ…"] || "Ù„Ø§";
  const cook   = answers["ÙˆÙ‚Øª_Ø·Ø¨Ø®"] || "Ù…ØªÙˆØ³Ø·";
  const budget = answers["Ù…ÙŠØ²Ø§Ù†ÙŠØ©"] || "Ù…ØªÙˆØ³Ø·Ø©";
  const tastes = answers["Ø£Ø°ÙˆØ§Ù‚"] || "";

  // Safety hints
  const safety = [];
  if(Number.isFinite(sleepH) && sleepH < 6) safety.push("Ù†ÙˆÙ…Ùƒ Ù‚Ù„ÙŠÙ„ØŒ Ø¬Ø±Ù‘Ø¨ ØªÙˆØµÙ„Ù‡ Ù„Ù€ 7â€“9 Ø³Ø§Ø¹Ø§Øª.");
  if(Number.isFinite(waterL) && waterL < 1.5) safety.push("Ù…ÙŠÙ‘Ùƒ Ù‚Ù„ÙŠÙ„Ø©ØŒ Ø®Ù„Ù‘ÙŠÙ‡Ø§ Ø­ÙˆØ§Ù„ÙŠ 2 Ù„ØªØ± ÙŠÙˆÙ…ÙŠØ§Ù‹ (Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©).");

  // Calcs
  const bmr = mifflinStJeor(sex, weight, height, age);
  const tdee = bmr * activityFactor(act);
  const bmi = weight && height ? weight / ((height/100)**2) : null;

  const speedMap = { "Ø³Ø±ÙŠØ¹":0.25, "Ù…ØªÙˆØ³Ø·":0.18, "Ù‡Ø§Ø¯Ø¦":0.12 };
  const adj = speedMap[speed] ?? 0.18;
  let targetCal;
  if(goal === "ØªÙ†Ø­ÙŠÙ"){
    targetCal = tdee * (1 - adj);
    targetCal = clamp(targetCal, sex==="Ø£Ù†Ø«Ù‰"?1200:1400, tdee - 200);
  }else{
    targetCal = tdee * (1 + adj);
    targetCal = clamp(targetCal, tdee + 150, tdee + 600);
  }

  // Macros
  const prot_g = 2.0 * weight;
  const prot_k = prot_g * 4;
  const fat_g  = Math.max(0.8 * weight, 40);
  const fat_k  = fat_g * 9;
  const carbs_k = Math.max(targetCal - (prot_k + fat_k), 0);
  const carbs_g = carbs_k / 4;

  // Training
  let train;
  if(place.includes("Ù†Ø§Ø¯ÙŠ")){
    train = [
      "Ø§Ù„ÙŠÙˆÙ… 1: ØµØ¯Ø± + ÙƒØªØ§Ù + ØªØ±Ø§ÙŠ (3â€“4 ØªÙ…Ø§Ø±ÙŠÙ† Ã— 3 Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ã— 8â€“12)",
      "Ø§Ù„ÙŠÙˆÙ… 2: Ø¸Ù‡Ø± + Ø¨Ø§ÙŠ (3â€“4 ØªÙ…Ø§Ø±ÙŠÙ† Ã— 3 Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ã— 8â€“12)",
      "Ø§Ù„ÙŠÙˆÙ… 3: Ø£Ø±Ø¬Ù„ + ÙƒÙˆØ± (Ø³ÙƒÙˆØ§Øª/Ù„ÙˆÙ†Ø¬ + Ø¨Ù„Ø§Ù†Ùƒ)",
      "Ø§Ù„ÙŠÙˆÙ… 4: ÙƒØ§Ø±Ø¯ÙŠÙˆ 20â€“30 Ø¯Ù‚ÙŠÙ‚Ø© + Ù…Ø´ÙŠ 8â€“10 Ø¢Ù„Ø§Ù Ø®Ø·ÙˆØ©",
      "Ø§Ù„ÙŠÙˆÙ… 5: ÙÙˆÙ„ Ø¨Ø§Ø¯ÙŠ Ø®ÙÙŠÙ Ø£Ùˆ Ø±Ø§Ø­Ø© Ù†Ø´Ø·Ø©",
      "Ø§Ù„ÙŠÙˆÙ… 6â€“7: Ø±Ø§Ø­Ø©/Ù…Ø´ÙŠ Ø®ÙÙŠÙ"
    ];
  } else if(place.includes("Ø¨ÙŠØª")){
    train = [
      "Ø§Ù„ÙŠÙˆÙ… 1: ÙˆØ²Ù† Ø¬Ø³Ù… (Ø¨ÙˆØ´-Ø£Ø¨ØŒ Ø³ÙƒÙˆØ§ØªØŒ Ø¨Ù„Ø§Ù†Ùƒ) 20â€“25 Ø¯Ù‚ÙŠÙ‚Ø©",
      "Ø§Ù„ÙŠÙˆÙ… 2: Ù…Ø´ÙŠ Ø³Ø±ÙŠØ¹ 30â€“40 Ø¯Ù‚ÙŠÙ‚Ø©",
      "Ø§Ù„ÙŠÙˆÙ… 3: Ù…Ø·Ù‘ ÙˆØªÙˆØ§Ø²Ù† + ÙƒÙˆØ±",
      "Ø§Ù„ÙŠÙˆÙ… 4: Ù…Ù‚Ø§ÙˆÙ…Ø© Ø¨Ø£Ø´Ø±Ø·Ø©/Ø¯Ù…Ø¨Ù„ Ø®ÙÙŠÙ",
      "Ø§Ù„ÙŠÙˆÙ… 5: Ù…Ø´ÙŠ 30 Ø¯Ù‚ÙŠÙ‚Ø©",
      "Ø§Ù„ÙŠÙˆÙ… 6â€“7: Ø±Ø§Ø­Ø©/Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ"
    ];
  } else {
    train = [
      "5 Ø£ÙŠØ§Ù… Ù…Ø´ÙŠ 30â€“45 Ø¯Ù‚ÙŠÙ‚Ø©",
      "Ù‡Ø¯Ù Ø®Ø·ÙˆØ§Øª ÙŠÙˆÙ…ÙŠ Ø­Ø³Ø¨ Ù‚Ø¯Ø±ØªÙƒ (Ù…Ø«Ù„Ø§Ù‹ 7000â€“9000 Ø®Ø·ÙˆØ©).",
      "Ø¬Ù„Ø³Ø© Ø¥Ø·Ø§Ù„Ø§Øª 10 Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø´ÙŠ."
    ];
  }

  const {base: mealsBase, tips: mealsTip, extra: mealsExtra} = mealOptions(diet, goal, budget);
  const weekMenu = Array.from({length:7}).map((_,i)=>{
    const portion = goal==="ØªÙ†Ø­ÙŠÙ" ? "Ø­ØµØµ Ù…Ø¹ØªØ¯Ù„Ø© + ØµØ­Ù† Ø³Ù„Ø·Ø© ÙƒØ¨ÙŠØ±" : "Ø­ØµØµ Ø£ÙƒØ¨Ø± Ø´ÙˆÙŠ + ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©";
    return `- Ø§Ù„ÙŠÙˆÙ… ${i+1}: ${mealsBase[0]} | ${mealsBase[1]} | ${mealsBase[2]} | Ø³Ù†Ø§Ùƒ: ${mealsBase[3].replace("Ø³Ù†Ø§Ùƒ: ","")} (${portion})`;
  });

  const medNote = (conds && conds.trim() && conds.trim()!=="Ù„Ø§") ? "Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ù…Ø§ Ø¥Ù†Ùƒ Ø°ÙƒØ±Øª Ø£Ù…Ø±Ø§Ø¶/Ø£Ø¯ÙˆÙŠØ©ØŒ ÙŠÙÙØ¶Ù‘Ù„ ØªØ³ØªØ´ÙŠØ± Ø·Ø¨ÙŠØ¨ Ù‚Ø¨Ù„ Ø£ÙŠ ØªØºÙŠÙŠØ± ÙƒØ¨ÙŠØ±." : "";
  const allergNote = allergy ? `ØªÙ†Ø¨ÙŠÙ‡ Ø­Ø³Ø§Ø³ÙŠØ©: ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªØ§Ù„ÙŠØ©: ${allergy}.` : "";
  const fastingNote = (String(fasting).includes("Ù†Ø¹Ù…") || String(fasting).includes("ØµÙˆÙ…")) ? "ØªÙ… Ù…Ø±Ø§Ø¹Ø§Ø© Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØµÙˆÙ…: Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø¥ÙØ·Ø§Ø± Ù…ØªÙˆØ§Ø²Ù† ÙˆØ³Ø­ÙˆØ± ØºÙ†ÙŠ Ø¨Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† ÙˆØ§Ù„Ø£Ù„ÙŠØ§Ù." : "";
  const stepsNote = `Ù‡Ø¯Ù Ø®Ø·ÙˆØ§Øª Ù…Ù‚ØªØ±Ø­: ${Math.trunc(clamp((steps||0) + (goal==='ØªÙ†Ø­ÙŠÙ'?1000:500), 4000, 12000))} Ø®Ø·ÙˆØ©/Ø§Ù„ÙŠÙˆÙ….`;

  // Assemble plan text
  const lines = [];
  lines.push(`Ø®Ø·Ø© ${goal==='ØªÙ†Ø­ÙŠÙ'?'ØªÙ†Ø­ÙŠÙ':'ØªØ³Ù…ÙŠÙ†'} Ù…Ø®ØµØµØ© â€” ${name}`);
  lines.push("==================================================");
  lines.push("ğŸ” Ø§Ù„Ù…Ù„Ø®Ù‘Øµ Ø§Ù„Ø³Ø±ÙŠØ¹:");
  lines.push(`- Ø§Ù„Ø·ÙˆÙ„: ${r(height)} Ø³Ù… | Ø§Ù„ÙˆØ²Ù†: ${r(weight)} ÙƒØº | Ø§Ù„Ø¹Ù…Ø±: ${r(age)} | Ø§Ù„Ø¬Ù†Ø³: ${sex}`);
  if(bmi) lines.push(`- Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù… (BMI): ${r(bmi,2)}`);
  lines.push(`- Ø§Ù„Ù†Ø´Ø§Ø·: ${act}`);
  lines.push(`- BMR ØªÙ‚Ø¯ÙŠØ±ÙŠ: ${r(bmr)} Ø³Ø¹Ø±Ø© | TDEE ØªÙ‚Ø¯ÙŠØ±ÙŠ: ${r(tdee)} Ø³Ø¹Ø±Ø©`);
  lines.push(`- Ø§Ù„Ù‡Ø¯Ù: ${goal} | Ø§Ù„Ø³Ø±Ø¹Ø©: ${speed}`);
  lines.push("");
  lines.push("ğŸ½ï¸ Ø§Ù„Ø³Ø¹Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø§ÙƒØ±ÙˆØ²:");
  lines.push(`- Ø³Ø¹Ø±Ø§Øª Ù…Ø³ØªÙ‡Ø¯ÙØ© ÙŠÙˆÙ…ÙŠØ§Ù‹: ${r(targetCal)} Ø³Ø¹Ø±Ø©`);
  lines.push(`- Ø¨Ø±ÙˆØªÙŠÙ†: ${r(prot_g)} Øº (${r(prot_k)} Ø³Ø¹Ø±Ø©)`);
  lines.push(`- Ø¯Ù‡ÙˆÙ†: ${r(fat_g)} Øº (${r(fat_k)} Ø³Ø¹Ø±Ø©)`);
  lines.push(`- ÙƒØ§Ø±Ø¨: ${r(carbs_g)} Øº (${r(carbs_k)} Ø³Ø¹Ø±Ø©)`);
  lines.push("");
  lines.push("ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙ…Ø§Ø±ÙŠÙ† Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Ù…Ø±Ù†):");
  train.forEach(t => lines.push(`  â€¢ ${t}`));
  lines.push(stepsNote);
  lines.push("");
  lines.push("ğŸ¥— Ø®Ø·Ø© Ø£ÙƒÙ„ Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø¨Ø¯Ù‘Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø±Ø§Ø­ØªÙƒ):");
  weekMenu.forEach(d => lines.push(d));
  lines.push("");
  lines.push("ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:");
  lines.push(`- ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${meals}`);
  lines.push(`- Ø´Ø±Ø¨ Ø§Ù„Ù…ÙŠ: ${r(waterL,1)} Ù„ØªØ±/Ø§Ù„ÙŠÙˆÙ… (Ø²ÙŠØ¯/ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø·Ø´ ÙˆØ§Ù„Ù†Ø´Ø§Ø·).`);
  lines.push(`- Ø§Ù„Ù†ÙˆÙ…: ${r(sleepH)} Ø³Ø§Ø¹Ø§Øª/Ø§Ù„ÙŠÙˆÙ….`);
  if(fastingNote) lines.push(`- ${fastingNote}`);
  if(medNote) lines.push(`- ${medNote}`);
  if(allergNote) lines.push(`- ${allergNote}`);
  if(tastes) lines.push(`- ØªÙØ¶ÙŠÙ„Ø§ØªÙƒ/ØªØ¬Ù†Ù‘Ø¨: ${tastes}`);
  lines.push(`- Ù†ØµÙŠØ­Ø©: ${mealsTip} | ${mealsExtra}`);
  safety.forEach(s => lines.push(`- âš ï¸ ${s}`));
  lines.push("");
  lines.push("ğŸ“Œ ØªØ°ÙƒÙŠØ±: Ù‡Ø§Ù„Ø®Ø·Ø© Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© Ø¹Ø§Ù…Ø©ØŒ Ù…Ùˆ Ø¨Ø¯ÙŠÙ„ Ø¹Ù† Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø®ØªØµØŒ Ø®ØµÙˆØµÙŠ Ø¨Ø­Ø§Ù„Ø§Øª Ù…Ø±Ø¶ÙŠØ©.");

  planText = lines.join("\n");

  // Show in chat
  addMsg("bot", "Ø®Ù„ØµÙ†Ø§ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©! Ø¹Ù… Ø­Ø¶Ù‘Ø±Ù„Ùƒ Ø§Ù„Ø®Ù„Ø§ØµØ© ÙˆØ§Ù„Ø®Ø·Ø©â€¦");
  addMsg("bot", "ğŸ‘‡ Ù‡ÙŠ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ø­Ø³Ø¨ Ø£Ø¬ÙˆØ¨ØªÙƒ:", `<pre style="margin:0;white-space:pre-wrap">${escapeHtml(planText)}</pre>`);

  input.disabled = true; sendBtn.disabled = true; saveBtn.disabled = false;
}

function escapeHtml(s){
  return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
}

/* ---------- Events ---------- */
startBtn.addEventListener("click", startChat);
resetBtn.addEventListener("click", resetAll);
saveBtn.addEventListener("click", savePlan);
sendBtn.addEventListener("click", onSend);
input.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); onSend(); }
});
</script>
</body>
</html>
